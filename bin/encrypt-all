#!/usr/bin/env ruby

if ARGV.empty? or ENV["SECRET"].nil?
  abort("Usage: SECRET=<yoursecret> encrypt-all <dirname>")
end

src = ARGV[0]
dst = ARGV[1] || "encrypted"

unless File.directory?(dst)
  require "fileutils"
  FileUtils.mkdir_p(dst)
end

Dir["%s/*" % src].each do |file|
  out = %x{cat #{file} | openssl des3 -salt -pass env:SECRET | openssl base64}

  target = "%s/%s" % [dst, File.basename(file)]

  File.open(target, "w") do |io|
    io.write out
    puts "%40s -----> %s" % [file, target]
  end
end
