#!/usr/bin/env ruby

Encoding.default_external = "UTF-8"

glob   = ARGV[0]
except = Dir[*ARGV[1..-1]] if ARGV.length > 1

Dir[glob].each do |file|
  next if File.directory?(file)
  next if except && except.include?(file)
  next if file =~ /(gif|png|jpe?g|bmp|ico|otf|ttf|gem)$/

  puts "-----> Cleaning out #{file}"

  data = File.read(file, encoding: "UTF-8")

  begin
    cleaned =
      data.
        split("\n").
        map { |line| line.gsub(/^\s+$/, "").gsub(/\s+$/, "") }.
        join("\n").
        strip + "\n"

    File.open(file, 'w') { |f| f.write cleaned }
  rescue
    puts "!! Unable to clean #{file}"
  end
end
